<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mi Compra">
    <title>Mi Compra - Esc√°ner Supermercado</title>
    
    <link rel="manifest" id="manifest-placeholder">
    <link rel="icon" type="image/png" sizes="192x192" id="icon-192">
    <link rel="apple-touch-icon" id="apple-icon">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <style>
        body {
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100">
    <div id="app"></div>

    <script>
        const manifestData = {
            "name": "Mi Compra - Esc√°ner Supermercado",
            "short_name": "Mi Compra",
            "description": "Escanea productos del supermercado",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#4F46E5",
            "theme_color": "#4F46E5",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%234F46E5' width='192' height='192' rx='48'/%3E%3Cpath fill='white' d='M60 50h12l8 50h44l8-30H70l-2-12h68l-12 52H68l-10-60H48v-12h12zm32 90c-8 0-14 6-14 14s6 14 14 14 14-6 14-14-6-14-14-14zm40 0c-8 0-14 6-14 14s6 14 14 14 14-6 14-14-6-14-14-14z'/%3E%3C/svg%3E",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%234F46E5' width='512' height='512' rx='128'/%3E%3Cpath fill='white' d='M160 133h32l21 133h117l21-80H187l-5-32h181l-32 139H181l-27-160H128v-32h32zm85 240c-21 0-37 16-37 37s16 37 37 37 37-16 37-37-16-37-37-37zm107 0c-21 0-37 16-37 37s16 37 37 37 37-16 37-37-16-37-37-37z'/%3E%3C/svg%3E",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
        
        const iconURL = manifestData.icons[0].src;
        document.getElementById('icon-192').setAttribute('href', iconURL);
        document.getElementById('apple-icon').setAttribute('href', iconURL);
    </script>

    <script type="module">
        const { useState, useEffect, useRef, createElement: h } = React;
        
        const Camera = () => h('svg', {className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z'}),
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 13a3 3 0 11-6 0 3 3 0 016 0z'})
        );
        
        const ShoppingCart = () => h('svg', {className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z'})
        );
        
        const Trash = () => h('svg', {className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16'})
        );
        
        const Plus = () => h('svg', {className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4'})
        );
        
        const Minus = () => h('svg', {className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M20 12H4'})
        );
        
        const Loader = () => h('svg', {className: 'w-6 h-6 animate-spin', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15'})
        );
        
        const History = () => h('svg', {className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'})
        );
        
        const Check = () => h('svg', {className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M5 13l4 4L19 7'})
        );
        
        const ArrowLeft = () => h('svg', {className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 19l-7-7 7-7'})
        );
        
        const Calendar = () => h('svg', {className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'})
        );
        
        const Alert = () => h('svg', {className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24'}, 
            h('path', {strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'})
        );

        function ShoppingScanner() {
            const [currentShopping, setCurrentShopping] = useState(null);
            const [items, setItems] = useState([]);
            const [shoppingHistory, setShoppingHistory] = useState([]);
            const [scanning, setScanning] = useState(false);
            const [error, setError] = useState('');
            const [scanProgress, setScanProgress] = useState('');
            const [view, setView] = useState('current');
            const fileInputRef = useRef(null);

            useEffect(() => {
                const loadData = () => {
                    try {
                        const current = localStorage.getItem('current-shopping');
                        if (current) {
                            const data = JSON.parse(current);
                            setCurrentShopping(data.shopping);
                            setItems(data.items);
                        }
                        
                        const history = localStorage.getItem('shopping-history');
                        if (history) {
                            setShoppingHistory(JSON.parse(history));
                        }
                    } catch (err) {
                        console.log('No hay datos guardados');
                    }
                };
                loadData();
            }, []);

            useEffect(() => {
                if (currentShopping) {
                    localStorage.setItem('current-shopping', JSON.stringify({
                        shopping: currentShopping,
                        items: items
                    }));
                }
            }, [currentShopping, items]);

            useEffect(() => {
                if (shoppingHistory.length > 0) {
                    localStorage.setItem('shopping-history', JSON.stringify(shoppingHistory));
                }
            }, [shoppingHistory]);

            const startNewShopping = () => {
                const newShopping = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    name: `Compra ${new Date().toLocaleDateString('es-ES')}`
                };
                setCurrentShopping(newShopping);
                setItems([]);
                setView('current');
            };

            const finishShopping = () => {
                if (!currentShopping || items.length === 0) return;
                
                if (confirm('¬øFinalizar esta compra y guardarla en el historial?')) {
                    const completedShopping = {
                        ...currentShopping,
                        items: items,
                        total: calculateTotal(),
                        completedAt: new Date().toISOString()
                    };
                    
                    setShoppingHistory([completedShopping, ...shoppingHistory]);
                    setCurrentShopping(null);
                    setItems([]);
                    localStorage.removeItem('current-shopping');
                }
            };

            const deleteHistoryItem = (id) => {
                if (confirm('¬øEliminar esta compra del historial?')) {
                    const newHistory = shoppingHistory.filter(s => s.id !== id);
                    setShoppingHistory(newHistory);
                    if (newHistory.length === 0) {
                        localStorage.removeItem('shopping-history');
                    }
                }
            };

            const extractPriceAndName = (text) => {
                const lines = text.split('\n').filter(l => l.trim().length > 0);
                
                const pricesFound = [];
                // Buscar precios con ‚Ç¨ o sin ‚Ç¨
                const pricePatterns = [
                    /‚Ç¨\s*(\d+)[.,](\d{2})/g,
                    /(\d+)[.,](\d{2})\s*‚Ç¨/g,
                    /(\d+)[.,](\d{2})/g
                ];
                
                lines.forEach((line, index) => {
                    pricePatterns.forEach(pattern => {
                        let match;
                        const lineStr = String(line);
                        while ((match = pattern.exec(lineStr)) !== null) {
                            const price = parseFloat(`${match[1]}.${match[2]}`);
                            if (price >= 0.10 && price <= 999) {
                                // Calcular "importancia" del precio basado en:
                                // 1. Posici√≥n en el texto (arriba = m√°s importante)
                                // 2. Tama√±o del n√∫mero (m√°s grande = m√°s importante)
                                const positionScore = (10 - index) * 2; // Primeras l√≠neas m√°s importantes
                                const sizeScore = price; // Precio m√°s alto tiene m√°s peso
                                
                                pricesFound.push({
                                    price: price,
                                    line: line,
                                    lineIndex: index,
                                    score: positionScore + sizeScore,
                                    rawMatch: match[0]
                                });
                            }
                        }
                    });
                });

                if (pricesFound.length === 0) {
                    return { name: '', price: 0 };
                }

                // Ordenar por puntuaci√≥n (score) - el precio principal tendr√° mayor score
                pricesFound.sort((a, b) => b.score - a.score);
                
                // Si el precio m√°s grande es significativamente mayor, es probablemente el principal
                const maxPrice = Math.max(...pricesFound.map(p => p.price));
                const topPrices = pricesFound.filter(p => p.price >= maxPrice * 0.8); // Precios similares al m√°ximo
                
                // De los precios "grandes", elegir el que est√° m√°s arriba
                topPrices.sort((a, b) => a.lineIndex - b.lineIndex);
                const mainPrice = topPrices[0] || pricesFound[0];

                // Buscar nombre en las primeras l√≠neas
                let productName = '';
                for (let i = 0; i < Math.min(6, lines.length); i++) {
                    const line = lines[i].trim();
                    const hasLetters = /[a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë]{3,}/i.test(line);
                    const notOnlyNumbers = !/^\d+$/.test(line);
                    const notBarcode = line.length < 20 || !/^\d{8,}$/.test(line);
                    
                    if (hasLetters && notOnlyNumbers && notBarcode && line.length > 2) {
                        productName = line
                            .replace(/\d+[.,]\d{2}/g, '')
                            .replace(/‚Ç¨/g, '')
                            .replace(/[^\w\s√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë]/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();
                        if (productName.length >= 3) break;
                    }
                }

                return {
                    name: productName.substring(0, 50) || 'Producto',
                    price: mainPrice.price
                };
            };

            const processImageWithOCR = async (file) => {
                setScanProgress('üì§ Optimizando imagen para m√≥vil...');
                
                // Comprimir y redimensionar imagen para m√≥vil
                const compressedImage = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            
                            // Redimensionar manteniendo aspecto si es muy grande
                            let width = img.width;
                            let height = img.height;
                            const maxDimension = 1600; // Aumentado de 1024 a 1600
                            
                            if (width > maxDimension || height > maxDimension) {
                                if (width > height) {
                                    height = (height / width) * maxDimension;
                                    width = maxDimension;
                                } else {
                                    width = (width / height) * maxDimension;
                                    height = maxDimension;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Comprimir a JPEG con calidad 0.85 (aumentado de 0.8)
                            canvas.toBlob((blob) => {
                                const reader2 = new FileReader();
                                reader2.onload = () => resolve(reader2.result.split(',')[1]);
                                reader2.onerror = () => reject(new Error('Error comprimiendo'));
                                reader2.readAsDataURL(blob);
                            }, 'image/jpeg', 0.85);
                        };
                        img.onerror = () => reject(new Error('Error cargando imagen'));
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject(new Error('Error leyendo archivo'));
                    reader.readAsDataURL(file);
                });

                setScanProgress('üîç Analizando etiqueta (5-10 segundos)...');
                
                try {
                    const response = await fetch('https://api.ocr.space/parse/image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'apikey': 'helloworld',
                            'base64Image': `data:image/jpeg;base64,${compressedImage}`,
                            'language': 'spa',
                            'isOverlayRequired': 'false',
                            'detectOrientation': 'true',
                            'scale': 'true',
                            'OCREngine': '2',
                            'filetype': 'JPG'
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Error en el servicio OCR');
                    }

                    const data = await response.json();
                    
                    if (data.IsErroredOnProcessing) {
                        throw new Error(data.ErrorMessage || 'Error procesando imagen');
                    }
                    
                    if (!data.ParsedResults || data.ParsedResults.length === 0) {
                        throw new Error('No se pudo leer texto en la etiqueta');
                    }

                    const text = data.ParsedResults[0].ParsedText;
                    
                    if (!text || text.trim().length === 0) {
                        throw new Error('No se detect√≥ texto. Aseg√∫rate de que la etiqueta est√© enfocada');
                    }
                    
                    setScanProgress('üìù Extrayendo precio y nombre...');
                    
                    const { name, price } = extractPriceAndName(text);
                    
                    if (!price || price === 0) {
                        throw new Error('No se detect√≥ un precio v√°lido. Aseg√∫rate de que el precio sea visible');
                    }

                    if (!name || name.length < 2) {
                        throw new Error('No se detect√≥ el nombre del producto');
                    }

                    setScanProgress('‚úÖ ¬°Producto detectado!');
                    
                    // Limpiar progreso despu√©s de 1 segundo
                    setTimeout(() => setScanProgress(''), 1000);
                    
                    return { name, price };
                } catch (err) {
                    if (err.message.includes('fetch')) {
                        throw new Error('Error de conexi√≥n. Verifica tu internet');
                    }
                    throw err;
                }
            };

            const handleImageCapture = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!currentShopping) {
                    startNewShopping();
                }

                setScanning(true);
                setError('');
                setScanProgress('');
                
                try {
                    const product = await processImageWithOCR(file);
                    addItem(product.name, product.price);
                    setScanProgress('');
                } catch (err) {
                    setError(err.message || 'Error al escanear');
                    setScanProgress('');
                }
                
                setScanning(false);
                e.target.value = '';
            };

            const addItem = (name, price) => {
                const existingItemIndex = items.findIndex(item => item.name === name);
                
                if (existingItemIndex !== -1) {
                    updateQuantity(existingItemIndex, items[existingItemIndex].quantity + 1);
                } else {
                    setItems([...items, {
                        id: Date.now(),
                        name,
                        price,
                        quantity: 1
                    }]);
                }
            };

            const updateQuantity = (index, newQuantity) => {
                if (newQuantity <= 0) {
                    removeItem(index);
                    return;
                }
                const newItems = [...items];
                newItems[index].quantity = newQuantity;
                setItems(newItems);
            };

            const removeItem = (index) => {
                setItems(items.filter((_, i) => i !== index));
            };

            const calculateTotal = () => {
                return items.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2);
            };

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            if (view === 'history') {
                return h('div', {className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 pb-6'},
                    h('div', {className: 'bg-indigo-600 text-white p-4 shadow-lg'},
                        h('div', {className: 'max-w-md mx-auto flex items-center justify-between'},
                            h('button', {
                                onClick: () => setView('current'),
                                className: 'flex items-center gap-2 hover:bg-indigo-700 px-3 py-2 rounded-lg transition-colors'
                            },
                                h(ArrowLeft),
                                h('span', null, 'Volver')
                            ),
                            h('div', {className: 'flex items-center gap-2'},
                                h(History),
                                h('h1', {className: 'text-xl font-bold'}, 'Historial')
                            )
                        )
                    ),
                    h('div', {className: 'max-w-md mx-auto p-4 space-y-3'},
                        shoppingHistory.length === 0 
                            ? h('div', {className: 'text-center py-12 text-gray-500'},
                                h(History, {className: 'w-16 h-16 mx-auto mb-4 opacity-30'}),
                                h('p', {className: 'text-lg'}, 'No hay compras anteriores')
                            )
                            : shoppingHistory.map(shopping => 
                                h('div', {key: shopping.id, className: 'bg-white rounded-lg shadow-md p-4'},
                                    h('div', {className: 'flex items-start justify-between mb-3'},
                                        h('div', {className: 'flex-1'},
                                            h('div', {className: 'flex items-center gap-2 text-gray-600 text-sm mb-1'},
                                                h(Calendar),
                                                h('span', null, formatDate(shopping.completedAt))
                                            ),
                                            h('h3', {className: 'font-bold text-lg text-indigo-600'}, `‚Ç¨${shopping.total}`),
                                            h('p', {className: 'text-sm text-gray-500'}, 
                                                `${shopping.items.length} ${shopping.items.length === 1 ? 'producto' : 'productos'}`
                                            )
                                        ),
                                        h('button', {
                                            onClick: () => deleteHistoryItem(shopping.id),
                                            className: 'p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors'
                                        }, h(Trash))
                                    ),
                                    h('div', {className: 'border-t pt-3 space-y-2'},
                                        shopping.items.map(item =>
                                            h('div', {key: item.id, className: 'flex justify-between text-sm'},
                                                h('span', {className: 'text-gray-700'}, `${item.quantity}x ${item.name}`),
                                                h('span', {className: 'font-semibold text-gray-900'}, `‚Ç¨${(item.price * item.quantity).toFixed(2)}`)
                                            )
                                        )
                                    )
                                )
                            )
                    )
                );
            }

            return h('div', {className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 pb-24'},
                h('div', {className: 'bg-indigo-600 text-white p-4 shadow-lg'},
                    h('div', {className: 'max-w-md mx-auto'},
                        h('div', {className: 'flex items-center justify-between mb-2'},
                            h('div', {className: 'flex items-center gap-2'},
                                h(ShoppingCart),
                                h('h1', {className: 'text-xl font-bold'}, currentShopping ? 'Compra Actual' : 'Nueva Compra')
                            ),
                            h('button', {
                                onClick: () => setView('history'),
                                className: 'flex items-center gap-2 bg-indigo-700 hover:bg-indigo-800 px-3 py-2 rounded-lg transition-colors'
                            },
                                h(History, {className: 'w-5 h-5'}),
                                h('span', {className: 'text-sm'}, 'Historial')
                            )
                        ),
                        currentShopping && [
                            h('div', {key: 'total', className: 'text-right'},
                                h('div', {className: 'text-sm opacity-90'}, 'Total'),
                                h('div', {className: 'text-3xl font-bold'}, `‚Ç¨${calculateTotal()}`),
                                h('div', {className: 'text-xs opacity-75 mt-1'}, 
                                    `${items.length} ${items.length === 1 ? 'producto' : 'productos'}`
                                )
                            ),
                            items.length > 0 && h('div', {key: 'finish', className: 'mt-3'},
                                h('button', {
                                    onClick: finishShopping,
                                    className: 'w-full bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors flex items-center justify-center gap-2'
                                },
                                    h(Check),
                                    h('span', {className: 'font-semibold'}, 'Finalizar Compra')
                                )
                            )
                        ]
                    )
                ),
                scanProgress && h('div', {className: 'max-w-md mx-auto mt-4 p-4'},
                    h('div', {className: 'bg-blue-100 border border-blue-300 rounded-lg p-3 text-center'},
                        h('p', {className: 'text-sm text-blue-800 font-medium'}, scanProgress)
                    )
                ),
                error && h('div', {className: 'max-w-md mx-auto mt-4 p-4'},
                    h('div', {className: 'bg-red-100 border border-red-300 rounded-lg p-3'},
                        h('p', {className: 'text-sm text-red-800 font-semibold'}, '‚ùå Error'),
                        h('p', {className: 'text-xs text-red-700 mt-1'}, error),
                        h('p', {className: 'text-xs text-red-600 mt-2'}, 
                            'üí° Aseg√∫rate de tener internet y que el precio sea visible'
                        )
                    )
                ),
                h('div', {className: 'max-w-md mx-auto p-4 space-y-3'},
                    !currentShopping 
                        ? h('div', {className: 'text-center py-12'},
                            h(ShoppingCart, {className: 'w-16 h-16 mx-auto mb-4 text-gray-400'}),
                            h('p', {className: 'text-lg text-gray-600 mb-4'}, 'No hay una compra activa'),
                            h('button', {
                                onClick: startNewShopping,
                                className: 'bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors'
                            }, 'Iniciar Nueva Compra')
                        )
                        : items.length === 0
                            ? h('div', {className: 'text-center py-12 text-gray-500'},
                                h(Camera, {className: 'w-16 h-16 mx-auto mb-4 opacity-30'}),
                                h('p', {className: 'text-lg'}, 'Lista vac√≠a'),
                                h('p', {className: 'text-sm mt-2 px-4'}, 'Escanea productos para a√±adirlos'),
                                h('div', {className: 'mt-6 bg-white rounded-lg p-4 text-left text-xs space-y-2'},
                                    h('p', {className: 'font-semibold text-gray-700'}, 'üì∏ Tips:'),
                                    h('p', {className: 'text-gray-600'}, '‚Ä¢ Enfoca el PRECIO GRANDE'),
                                    h('p', {className: 'text-gray-600'}, '‚Ä¢ Buena iluminaci√≥n'),
                                    h('p', {className: 'text-gray-600'}, '‚Ä¢ C√°mara estable y recta'),
                                    h('p', {className: 'text-gray-600'}, '‚Ä¢ Tarda 5-10 segundos')
                                )
                            )
                            : items.map((item, index) =>
                                h('div', {key: item.id, className: 'bg-white rounded-lg shadow-md p-4 flex items-center justify-between'},
                                    h('div', {className: 'flex-1 min-w-0 pr-3'},
                                        h('h3', {className: 'font-semibold text-gray-800 truncate'}, item.name),
                                        h('p', {className: 'text-sm text-gray-600'}, `‚Ç¨${item.price.toFixed(2)} / unidad`)
                                    ),
                                    h('div', {className: 'flex items-center gap-3 flex-shrink-0'},
                                        h('div', {className: 'flex items-center gap-2 bg-gray-100 rounded-lg px-2 py-1'},
                                            h('button', {
                                                onClick: () => updateQuantity(index, item.quantity - 1),
                                                className: 'p-1 hover:bg-gray-200 rounded'
                                            }, h(Minus, {className: 'text-gray-700'})),
                                            h('span', {className: 'w-8 text-center font-semibold'}, item.quantity),
                                            h('button', {
                                                onClick: () => updateQuantity(index, item.quantity + 1),
                                                className: 'p-1 hover:bg-gray-200 rounded'
                                            }, h(Plus, {className: 'text-gray-700'}))
                                        ),
                                        h('div', {className: 'text-right min-w-[60px]'},
                                            h('div', {className: 'font-bold text-indigo-600'}, `‚Ç¨${(item.price * item.quantity).toFixed(2)}`)
                                        ),
                                        h('button', {
                                            onClick: () => removeItem(index),
                                            className: 'p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors'
                                        }, h(Trash))
                                    )
                                )
                            )
                ),
                currentShopping && h('div', {className: 'fixed bottom-6 left-0 right-0 flex justify-center px-4'},
                    h('button', {
                        onClick: () => fileInputRef.current?.click(),
                        disabled: scanning,
                        className: `${
                            scanning
                                ? 'bg-gray-400 cursor-not-allowed' 
                                : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'
                        } text-white rounded-full px-6 py-4 shadow-2xl transition-all transform hover:scale-105 flex items-center gap-3 max-w-md w-full justify-center`
                    },
                        scanning 
                            ? [
                                h(Loader, {key: 'loader'}),
                                h('span', {key: 'text', className: 'font-semibold text-lg'}, 'Escaneando...')
                            ]
                            : [
                                h(Camera, {key: 'camera'}),
                                h('span', {key: 'text', className: 'font-semibold text-lg'}, 'Escanear Producto')
                            ]
                    ),
                    h('input', {
                        ref: fileInputRef,
                        type: 'file',
                        accept: 'image/*',
                        capture: 'environment',
                        onChange: handleImageCapture,
                        className: 'hidden'
                    })
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(h(ShoppingScanner));
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'mi-compra-v1';
                    const urlsToCache = [
                        './',
                        'https://cdn.tailwindcss.com',
                        'https://unpkg.com/react@18/umd/react.production.min.js',
                        'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('SW registrado'))
                    .catch(err => console.log('Error SW:', err));
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('app-installed')) {
                    const banner = document.createElement('div');
                    banner.className = 'fixed top-4 left-4 right-4 bg-indigo-600 text-white p-4 rounded-lg shadow-xl z-50 flex items-center justify-between';
                    banner.innerHTML = `
                        <div class="flex-1">
                            <p class="font-semibold">Instalar Mi Compra</p>
                            <p class="text-sm opacity-90">√ösala como app nativa</p>
                        </div>
                        <button id="install-btn" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold ml-3">
                            Instalar
                        </button>
                        <button id="close-banner" class="ml-2 p-2 hover:bg-indigo-700 rounded">
                            ‚úï
                        </button>
                    `;
                    document.body.appendChild(banner);
                    
                    document.getElementById('install-btn').addEventListener('click', async () => {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            localStorage.setItem('app-installed', 'true');
                        }
                        banner.remove();
                        deferredPrompt = null;
                    });
                    
                    document.getElementById('close-banner').addEventListener('click', () => {
                        banner.remove();
                    });
                }
            }, 3000);
        });
    </script>
</body>
</html>